@{
    ViewBag.Title = "Lista de Promociones BataClub";
}
<style>
    .boton-td {
        padding-top: 3px !important;
        padding-bottom: 3px !important;
    }

    .modal-body {
        max-height: calc(100vh - 212px);
        overflow-y: auto;
    }
</style>
<div class="box box-body box-primary">
    <div class="row">
        <div class="col-md-12">
            <a href="@Url.Action("CrearPromocion", "BataClub")" class="btn btn-primary"><i class="glyphicon glyphicon-plus"></i>&nbsp;Crear nueva promocion</a>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-md-12">
            <div id="lista">
                <table id="listaPromociones" class="table dt-lista table-hover dataTable table-striped table-responsive">
                    <thead>
                        <tr style="background-color:#3d566e; color:#ecf0f1">
                            <th>Codigo</th>
                            <th>Descripcion</th>
                            <th>Dcto (%)</th>
                            <th>Max Pares</th>
                            <th>Fec. Fin</th>
                            <th>Activa</th>
                            <th>Cupones</th>                            
                            <th>Generar</th>                            
                        </tr>
                    </thead>
                    <tbody data-bind="foreach:"></tbody>
                    <tfoot>
                        <tr>
                            <th>Codigo</th>
                            <th>Descripcion</th>
                            <th>Dcto (%)</th>
                            <th>Max Pares</th>
                            <th>Fec. Fin</th>
                            <th>Activa</th>         
                            <th>Cupones</th>
                            <th>Generar</th>                            
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalResultCupones" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog  modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="row">
                    <div class="col-md-6">
                        <p style="font-size:medium" class="text-primary modal-title" id="myModalLabel"><strong class="text-danger" id="descPromocionLista"></strong></p>
                        <p style="font-size:medium" class="text-primary modal-title" id="myModalLabel"><b>Lista de Cupones generados: &nbsp;</b></p>
                    </div>
                    <div class="col-md-6 text-right">
                        <a href="@Url.Action("ListaCuponesExcel","BataClub")" class="btn btn-success btn-sm"><i class="glyphicon glyphicon-export"></i>&nbsp;&nbsp;Exportar Lista</a>
                    </div>
                </div>
            </div>
            <div style="font-size:small" class="modal-body" id="divListaCupones">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<script src="@Url.Content("~/Scripts/bootstrap.min.js")"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    var actualizar = "";
    $(document).ready(function () {
        $('.dt-lista').DataTable({
            "language": {
                "url": "../Scripts/DataTables/Spanish.json"
            },
            "bServerSide": true,
            "bAutoWidth": false,
            "sAjaxSource": '@Url.Action("getListaPromocionesAjax", "BataClub")',
            "fnServerParams": function (aoData) {
                aoData.push({ "name": "actualizar", "value": actualizar });
            },
            "bdestroy": true,
            "start": 0,
            "order": [],
            "bDeferRender": true,
            "aoColumns": [
                  { "sName": "Codigo", "mData": "Codigo" },
                  { "sName": "Descripcion", "mData": "Descripcion", "class": "right" },
                  { "sName": "Porc_Dcto", "mData": "Porc_Dcto", "class": "right" },
                  { "sName": "MaxPares", "mData": "MaxPares", "class": "right" },
                  { "sName": "FechaFin", "mData": "FechaFin", "class": "right" },
                  {
                      "render": function (data, type, full) {
                          if (full.PromActiva == 1) {
                              return '<span class="label label-success">ACTIVO</span>'
                          } else {
                              return '<span class="label label-danger">CADUCADO</span>'
                          }
                      }
                  },
                  {
                      "render": function (data, type, full) {
                          return '<button title="Ver lista de cupones" class="btn btn-default btn-sm cupones" data-cod-prom="' + full.Codigo + '" data-des-prom="' + full.Descripcion + '"><i class="glyphicon glyphicon-list"></i></button>';
                      }, "sClass": "boton-td"
                  },
                  {
                      "render": function (data, type, full) {
                          var agregar = '';
                          if (full.PromActiva == 1){
                              agregar += '<form action="@Url.Action("GenerarCupon", "BataClub")" method="post">' +
                                  '<input type="hidden" name="codigo" value="' + full.Codigo + '"/>' +
                                  '<input type="hidden" name="descripcion" value="' + full.Descripcion + '" />' +
                                  '<input type="hidden" name="dscto" value="' + full.Porc_Dcto + '" />' +
                                  '<input type="hidden" name="fecha" value="' + full.FechaFin + '" />' +
                                  '<input type="hidden" name="pares" value="' + full.MaxPares + '" />' +
                                  '<button type="submit" class="btn btn-success btn-sm" title="Generar Cupones" ><i class="glyphicon glyphicon-plus"></i></button>'
                              return agregar;
                          }
                          else
                          {
                              return '';
                          }
                      }, "class": "boton-td"
                  }
            ]
        });
        $('.dt-lista').on('click', '.cupones', function (e) {
            waitingDialog.show('Espere un momento por favor');
            var codProm = $(this).attr('data-cod-prom');
            var desProm = $(this).attr('data-des-prom');
            $.ajax({
                type: "POST",
                url: '@Url.Action("getListaCupProm", "BataClub")',
                data: { codProm: codProm },
                dataType: "json",
                success: function (data) {
                    waitingDialog.hide();
                    if (data.estado == 1) {
                        var table = '<table id="listaCuponesRes" class="table table-condensed table-responsive table-borderer"><thead><tr style="background-color:#3d566e; color:#ecf0f1">' +
                                             '<th>Promocion</th><th>Dni</th><th>Nombres</th><th>Correo</th><th>Cupon</th></tr></thead><tbody data-bind="foreach:">';
                        for (var i = 0; i < data.listaCupones.length; i++) {
                            table += '<tr><td>' + data.listaCupones[i].promocion + '</td><td>' + data.listaCupones[i].dniCliente + '</td><td>' + data.listaCupones[i].nombresCliente + ' ' + data.listaCupones[i].apellidosCliente + '</td><td>' + data.listaCupones[i].correo + '</td><td>' + data.listaCupones[i].cupon + '</td></tr>'
                        }
                        table += '</tbody><tfoot><tr><th>Promocion</th><th>Dni</th><th>Nombres</th><th>Correo</th><th>Cupon</th></tr></tfoot></table>';
                        $("#descPromocionLista").html(desProm);
                        $("#divListaCupones").html(table);
                        $("#listaCuponesRes").DataTable({
                            "language": {
                                "url": "../Scripts/DataTables/Spanish.json"
                            },
                            //"deferRender": true
                        });
                        $("#modalResultCupones").modal({ backdrop: 'static', keyboard: false });
                    } else {
                        swal("Error", "No se pudo cargar la lista de articulos");
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    waitingDialog.hide();
                    var error = eval("(" + XMLHttpRequest.responseText + ")");
                    console.log(XMLHttpRequest.responseText);
                    alert(error.Message);
                }
            });

        });
    });



</script>