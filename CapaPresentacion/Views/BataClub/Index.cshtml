@using CapaEntidad.BataClub

@model IEnumerable<Ent_BataClub_CuponesCO>
@{
    ViewBag.Title = "Consulta de Cupones BataClub";
    AjaxOptions options = new AjaxOptions
    {
        HttpMethod = "GET",
        InsertionMode = InsertionMode.Replace,
        UpdateTargetId = "listaGuia",
        OnComplete = "waitingDialog.hide();",
        OnBegin = "waitingDialog.show('Espere un momento por favor');",
        OnFailure = "waitingDialog.hide();"
    };
}
<style>
    .dataTables_processing {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 40px;
        margin-left: -50%;
        margin-top: -25px;
        padding-top: 20px;
        text-align: center;
        font-size: 1.2em;
        background-color: white;
        font-weight: bold;
        color: cornflowerblue;
        background: -webkit-gradient(linear, left top, right top, color-stop(0%, rgba(255,255,255,0)), color-stop(25%, rgba(255,255,255,0.9)), color-stop(75%, rgba(255,255,255,0.9)), color-stop(100%, rgba(255,255,255,0)));
        background: -webkit-linear-gradient(left, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 25%, rgba(255,255,255,0.9) 75%, rgba(255,255,255,0) 100%);
        background: -moz-linear-gradient(left, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 25%, rgba(255,255,255,0.9) 75%, rgba(255,255,255,0) 100%);
        background: -ms-linear-gradient(left, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 25%, rgba(255,255,255,0.9) 75%, rgba(255,255,255,0) 100%);
        background: -o-linear-gradient(left, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 25%, rgba(255,255,255,0.9) 75%, rgba(255,255,255,0) 100%);
        background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 25%, rgba(255,255,255,0.9) 75%, rgba(255,255,255,0) 100%);
    }
    .boton-td{        
        padding-top: 3px !important;
        padding-bottom: 3px !important;
    }
    .modal-body {
        max-height: calc(100vh - 212px);
        overflow-y: auto;
    }
</style>
<link href="@Url.Content("~/Content/bootstrap-select.min.css")" rel="stylesheet" type="text/css" />
<p class="text-danger">Consulta de cupones BataClub por estado, promocion, dni, correo y codigo de cupón. </p>
<div class="box box-body box-primary">
    @using (Ajax.BeginForm("_Table", options))
    {
        <div class="row">
            <div class="col-sm-3" style="padding-left: 25px;">
                <div class="form-group">
                    <label for="dwest">Estado cupón</label>
                    @Html.DropDownList("dwest", new MultiSelectList(ViewBag.Estado, "est_id", "est_des", null), new { @class = "form-control selectpicker", @id = "dwest", @name = "dwest", @data_live_search = "true", @multiple = "multiple", @data_actions_box = "true", @data_selected_text_format = "count > 2" })
                </div>
            </div>
            <div class="col-sm-3" style="padding-left: 25px;">
                <div class="form-group">
                    <label for="dwprom">Promoción</label>
                    @Html.DropDownList("dwprom", new MultiSelectList(ViewBag.Promocion, "Codigo", "Descripcion", null), new { @class = "form-control selectpicker", @id = "dwprom", @data_live_search = "true", @multiple = "multiple", @data_actions_box = "true", @data_selected_text_format = "count > 2" })
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2" style="padding-left: 25px; margin-right: inherit;">
                <label for="segape" style="color: #3d566e;">DNI</label>
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon" style="color: #3d566e;"><i class="glyphicon glyphicon-user"></i></span>
                        <input id="dni" type="text" class="form-control" name="dni" placeholder="Ingresar DNI">
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="padding-left: 25px; margin-right: inherit;">
                <label for="segape" style="color: #3d566e;">Cupón</label>
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-barcode"></i></span>
                        <input id="cupon" type="text" class="form-control" name="cupon" placeholder="Ingresar cupon">
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="padding-left: 25px; margin-right: inherit;">
                <label for="segape" style="color: #3d566e;">Correo</label>
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
                        <input id="correo" type="text" class="form-control" name="correo" placeholder="Ingresar correo">
                    </div>
                </div>
            </div>
            <div class="col-sm-2" style="padding-left: 25px; width: 105px; margin-top: 23px; margin-bottom: 10px;">
                <button id="btnSearch" type="submit" title="Consultar" class="btn btn-primary">
                    <span class="glyphicon glyphicon-search"></span>&nbsp;&nbsp;Buscar
                </button>
            </div>
            <div class="col-md-2" style="width: 105px;margin-top: 23px;float: right; margin-right: 25px;">
                <a class="btn btn-success" href="@Url.Action("ExportToExcel")" title="Exportar a excel"><i class="glyphicon glyphicon-export"></i>&nbsp;&nbsp;Excel</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6" id="resumen">
                <div class="panel panel-primary p-10">
                    <div class="panel-body" style="padding-top: 7px;padding-bottom: 4px;">
                        <h5 class="text-bold text-info">Resumen</h5>
                        <p>
                            <span class="label label-primary" style="font-size:14px">
                                <b>Consumidos:</b><small class="text-right">&nbsp;<label id="lblConsumidos" name="lblConsumidos"></label></small>
                            </span>&nbsp;&nbsp;
                            <span class="label label-success" style="font-size:14px">
                                <b>Disponibles:</b><small class="text-right">&nbsp;<label id="lblDisponibles" name="lblDisponibles"></label></small>
                            </span>&nbsp;&nbsp;
                            <span class="label label-danger" style="font-size:14px"><b>Caducados:</b><small class="text-right">&nbsp;<label id="lblCaducados" name="lblCaducados" ></label></small></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }

    <div id="listaGuia" style="padding-bottom: 20px;">
        @{Html.RenderPartial("_Table", Model);}
    </div>   
</div>


<script src="~/Scripts/bootstrap-select.min.js"></script>
<script src="@Url.Content("~/Scripts/bootstrap.min.js")"></script>
<script>
    $(document).ready(function () {
        $('#lblConsumidos')[0].textContent = "0";
        $('#lblDisponibles')[0].textContent = "0";
        $('#lblCaducados')[0].textContent = "0";
        //$("#btnGrafica").click(function () {
        //    //  console.log("entro a boton graf");
        //    PopupDetalle();
        //});
        
    });
    function PopupCupones() {
        var ControllerUrl = "@Url.Action("Cupon", "BataClub")";
        // waitingDialog.show('Espere un momento por favor');
        var dwpromo = $.trim($('#dwpromo').val());
        $.ajax({
            type: "GET",
            url: ControllerUrl,
            contentType: "application/json; charset=utf-8",
            data: { dwpromo: dwpromo },
            datatype: "json",
            cache: true,
            success: function (data) {
                //   waitingDialog.hide();

                var options = { "backdrop": "static", keyboard: true };
                var descModal = 'Generar cupones de la promoción ' + $("#dwpromo option:selected").text() + ' ';
                //console.log("entro a data");
                // console.log(data);
                $('#myModalLabel2').html(descModal);
                $('#modalBody2').html(data);
                $('#myModal2').modal(options);
            },
            error: function (xhr) {
                // waitingDialog.hide();
                toastr.error(xhr, 'Mensaje');
            }
        });
    }

    function PopupDetalle() {
        var ControllerUrl = "@Url.Action("_popUpGrafica", "BataClub")";
        $.ajax({
            type: "GET",
            url: ControllerUrl,
            contentType: "application/json; charset=utf-8",
            data: {},
            datatype: "json",
            cache: true,
            success: function (data) {
                var options = { "backdrop": "static", keyboard: true };
                var descModal = 'Gráfica anual de Promociones';
                // console.log("entro a data");
                $('#myModalLabel').html(descModal);
                $('#modalBody1').html(data);
                $('#myModal1').modal(options);

                MostrarGrafico();

            },
            timeout: 10000,
            async: false,
            error: function (xhr) {
                toastr.error(xhr, 'Mensaje');
            }
        });
    }

    function MostrarGrafico() {
        //waitingDialog.show('Espere un momento por favor');
        //  console.log("entro a Mostrar grafico");
        var ControllerUrl_c = "@Url.Action("listarStr_graph", "BataClub")";
        $.ajax({
            type: "GET",
            url: ControllerUrl_c,
            contentType: "application/json; charset=utf-8",
            data: {},
            datatype: "json",
            cache: true,
            success: function (data) {
                if (data != '' && data != '[]') {
                    console.log("success");
                    var valors = JSON.parse(data);
                    // EXTRACT VALUE FOR HTML HEADER.
                    // ('Book ID', 'Book Name', 'Category' and 'Price')
                    var col = [];
                    for (var i = 0; i < valors.length; i++) {
                        for (var key in valors[i]) {
                            if (col.indexOf(key) === -1) {
                                col.push(key);
                            }
                        }
                    }
                    // CREATE DYNAMIC TABLE.
                    var table = document.createElement("table");
                    table.setAttribute("id", "datatable_graph");
                    // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
                    var tr = table.insertRow(-1);                   // TABLE ROW.

                    for (var i = 0; i < col.length; i++) {
                        var th = document.createElement("th");      // TABLE HEADER.
                        th.innerHTML = col[i];
                        tr.appendChild(th);
                    }

                    // ADD JSON DATA TO THE TABLE AS ROWS.
                    for (var i = 0; i < valors.length; i++) {

                        tr = table.insertRow(-1);

                        for (var j = 0; j < col.length; j++) {
                            var tabCell = tr.insertCell(-1);
                            tabCell.innerHTML = valors[i][col[j]];
                        }
                    }
                    // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
                    //console.log(table);
                    $("#container").html(table);
                    MostrarGrafico_contenido();
                }
                // waitingDialog.hide();
            },
            timeout: 10000,
            async: false,
            error: function () {
                // waitingDialog.hide();
                alert('Error')
            }
        });
    }

    function MostrarGrafico_contenido() {
        Highcharts.chart('containerGrafica', {
            data: {
                table: 'datatable_graph'
            },
            chart: {
                type: 'column'
            },
            title: {
                text: 'Cupones consumidos en el año actual por mes'
            },
            yAxis: {
                allowDecimals: false,
                title: {
                    text: 'Cantidad'
                }
            },
            tooltip: {
                formatter: function () {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.point.y + ' ' + this.point.name.toLowerCase();
                }
            }
        }
        , function (chart) {
            //para quitar la opción viewData
            var arr = chart.options.exporting.buttons.contextButton.menuItems;
            var index = arr.indexOf("viewData");
            if (index !== -1) arr.splice(index, 1);
        }
        );
    }
</script>
<script>
   
    function ListarTableCup() {
        var ControllerUrl = "@Url.Action("_TableCupon", "BataClub")";
        // waitingDialog.show('Espere un momento por favor');
        //  console.log("entro a popupdetalle");
        var identificacion = $.trim($('#identificacion').val());
        $.ajax({
            type: "GET",
            url: ControllerUrl,
            contentType: "application/json; charset=utf-8",
            data: { identificacion: identificacion },
            datatype: "json",
            cache: true,
            success: function (data) {
                //  waitingDialog.hide();
                console.log("listar tabla");
                //   console.log(data);
                $('#lista').html(data);
            },
            // timeout: 10000,
            // async: false,
            error: function (xhr) {
                //  waitingDialog.hide();
                toastr.error(xhr, 'Mensaje');
            }
        });
    }

    function ConfirmacionCupon() {
        var msg_titulo = 'Mensaje ';
        var message = "¿Está seguro de generar cupones a las siguientes personas?<br>";
        var cadena = "";

        $("#example2 a[type=button]").each(function () {
            var row = $(this).closest("tr")[0];
            message += " " + row.cells[0].innerHTML + " " + row.cells[1].innerHTML;
            message += " de DNI " + row.cells[2].innerHTML;
            message += " con el correo " + row.cells[3].innerHTML + ".";
            message += "<br>";
            cadena += $(this).attr("id") + ",";
        });
        //  console.log(cadena);
        if (cadena == null || cadena == "") {
            toastr.error("Por favor ingresar al menos un registro para poder generar el cupón.", msg_titulo);
            return false;
        }
        else {
            // e.preventDefault();
            bootbox.confirm({
                message: message,
                buttons: {
                    confirm: {
                        label: 'Si',
                        className: 'btn-success'
                    },
                    cancel: {
                        label: 'No',
                        className: 'btn-danger'
                    }
                },
                callback: function (result) {
                    // console.log(result);
                    if (result) {
                        //  console.log("Guardando registro")
                        Generar()
                    }
                }
            });

        }
    }

    function Generar() {
        var prom_des = $("#dwpromcp  option:selected").text();
        var desc = $("#desc").val();
        var pares = $("#pares").val();
        var fec_fin = $("#fec_fin").val();

        var ControllerUrl = "@Url.Action("GenerarCupones", "BataClub")";
        var msg_titulo = 'Mensaje';
        $.ajax({
            type: "GET",
            url: ControllerUrl,
            contentType: "application/json; charset=utf-8",
            data: { prom_des: prom_des, desc: desc, fec_fin: fec_fin, pares: pares },
            datatype: "json",
            success: function (data) {
                // console.log(data);
                if (data = "1") {
                    toastr.success("Se realizó exitosamente la generación de cupones.", msg_titulo);
                    ExportToExcelCup();
                }
                else {
                    //toastr.error("Error al momento de generar los cupones. Por favor contactarse con el administrador. " + data, msg_titulo);
                    toastr.error("Error al momento de generar los cupones. Por favor contactarse con el administrador. ", msg_titulo);
                }
            },
            error: function (xhr) {
                toastr.error(xhr, msg_titulo);
            }
        });
    }

    function ExportToExcelCup() {
        //console.log("entro a nuevo  exporta excel");
        window.location = "ExportToExcel_Cupones";
    }

    function EliminarSeleccion(dni) {
        //waitingDialog.show('Espere un momento por favor');
        $("#identificacion").val("");
        var ControllerUrl_c = "@Url.Action("BorrarRegistro", "BataClub")";
        $.ajax({
            type: "GET",
            url: ControllerUrl_c,
            contentType: "application/json; charset=utf-8",
            data: { dni: dni },
            datatype: "json",
            cache: true,
            success: function (data) {
                //  debugger;
                // waitingDialog.hide();
                console.log("eliminar seleccion");
                // console.log(data);
                // $("#identificacion").val("");
                //  $("#btnAgregar").submit();
                ListarTableCup();
            },
            error: function () {
                //  waitingDialog.hide();
                alert('Error')
            }
        });
    }

</script>